# **Atlas SDK v0.1.0**

ANy software in any programming languages on any blockchain.

## Beta version disclaimer

By using the beta version of the Atlas SDK, you acknowledge and understand the potential risks and the unfinished state of the product.

While we strive to offer a seamless experience, unexpected issues might occur. We highly recommend not using the beta version for critical tasks and always maintaining backups of your data.

## **Table of Contents**

- [Usage](#usage)
  - [1. Login](#1-login)
  - [2. Connecting crypto wallet](#2-connecting-crypto-wallet)
  - [3. Deploying a Virtualization Unit](#3-deploying-a-virtualization-unit)
  - [4. Compiling web2 code](#4-compiling-web2-code)
  - [5. Executing web2 code](#5-executing-web2-code)
- [Troubleshooting](#troubleshooting)
- [Contributing](#contributing)

## Getting started

### Signup

To use the SDK, you need to signup to the ChainsAtlas Dashboard at https://app.chainsatlas.com/signup

Once you signup, an API Key will be automatically generated and displayed to you at https://app.chainsatlas.com/dashboard.

Once you have your API Key at hand, use can start using `atlas-sdk`.

![Login](./assets/img/docs/login.png)

### Installation

```
npm i atlas-sdk
# or
pnpm i atlas-sdk
# or
yarn add atlas-sdk
```

### Features

The `atlas-sdk` goal is to convert traditional web2 code into code compatible with various web3 enviornment architectures. To enable this, it contains: 

- `Client` class that forwards requests containing web2 code to the ChainsAtlas compiler;
- `composeInput` utility function to input dynamic arguments into the generated bytecode,
- Virtualization Unit contract ABI and bytecode.

### Example

You can use the `atlas-sdk` with the main web3 packages such as `ethers`, `web3` and `viem`. The virtualization unit contract currently supports most EVM chains and additional support are coming soon to Stellar, XRPL and AElf. Below is an example code to deploy a virtualization unit and execute a factorial function built with C on Ethereum.

```ts
import { Client, composeInput, V_UNIT_ABI, V_UNIT_BYTECODE } from "atlas-sdk";
import { ethers } from "ethers";
import fs from "fs";
import path from "path";

function calculateBuffer(gas: string) {
  return ((BigInt(gas) * BigInt(115)) / BigInt(100)).toString();
}

async function deployContract(signer: ethers.Signer) {
  try {
    if (!signer.provider) {
      throw new Error("Signer does not have provider.");
    }

    const factory = new ethers.ContractFactory(
      V_UNIT_ABI,
      V_UNIT_BYTECODE,
      signer,
    );
    console.log("estimating gas to deploy virtualization unit...");
    const { data } = await factory.getDeployTransaction();
    const gasEstimate = await signer.provider.estimateGas({ data });

    if (!gasEstimate) {
      throw new Error("Invalid gas estimate.");
    }

    const gasLimit = calculateBuffer(gasEstimate.toString());
    console.log("gas limit =", gasLimit);
    console.log("deploying virtualization unit...");
    const contract = await factory.deploy({ gasLimit });
    await contract.waitForDeployment();
    const address = await contract.getAddress();
    console.log("virtualization unit deployed at ", address);
    return address;
  } catch (error) {
    console.error("Error deploying contract:", error);
  }
}

async function runCode(
  contractAddress: string,
  signer: ethers.Signer,
  filePath: string,
  language: "c",
  nargs: number,
  args: number[],
) {
  try {
    console.log("compiling code to virtualization-unit-compatible bytecode...");
    const code = fs.readFileSync(filePath, "utf-8");
    const clientBytecode = await client.compile(code, language, nargs);
    const input = composeInput(clientBytecode, args);

    console.log("estimating gas to execute bytecode...");
    const contract = new ethers.Contract(contractAddress, V_UNIT_ABI, signer);
    const gasEstimate = await contract.runBytecode.estimateGas(input);

    if (!gasEstimate) {
      throw new Error("Invalid gas estimate.");
    }

    const gasLimit = calculateBuffer(gasEstimate.toString());
    console.log("gas limit = ", gasLimit);
    const overrides = { gasLimit };
    console.log("executing bytecode...");
    const txResponse = await contract.runBytecode(input, overrides);
    const receipt = await txResponse.wait();
    console.log("bytecode executed. tx hash: ", receipt.hash);
    const eventFilter = contract.filters.ContractDeployed();
    const eventTopicArray = await eventFilter.getTopicFilter();

    if (!eventTopicArray || !eventTopicArray.length) {
      throw Error("Could not find event topic.");
    }

    // eslint-disable-next-line @typescript-eslint/no-explicit-any
    const logs = receipt.logs.filter((log: any) =>
      log.topics.includes(eventTopicArray[0]),
    );
    // eslint-disable-next-line @typescript-eslint/no-explicit-any
    const decodedLogs = logs.map((log: any) =>
      contract.interface.parseLog(log),
    );
    const bytecodeAddress = decodedLogs[0]?.args?.bytecodeAddress;

    if (!bytecodeAddress) {
      throw new Error("bytecodeAddress is null or undefined");
    }
    const output = await contract.getRuntimeReturn(bytecodeAddress);
    console.log("runtime return: ", output);
    return { output, txHash: receipt.hash };
  } catch (error) {
    console.error("Error running code:", error);
  }
}

// Atlas SDK client instantiated with user API Key
const client = new Client("API-KEY-HERE");
const provider = new ethers.JsonRpcProvider("RPC URL");
const wallet = new ethers.Wallet("PRIVATE_KEY"), provider);

deployContract(wallet).then((address) => {
  if (!address) {
    throw new Error("Invalid contract address.");
  }

  const filePath = path.resolve(__dirname, "./factorial.c");
  runCode(address, wallet, filePath, "c", 1, [3]).then((result) =>
    console.log(result),
  );
});
```

## Troubleshooting

If you encounter issues:

- Check the error message for guidance.
- Ensure API Key is correct.
- Ensure you are using a stable RPC.
- Make sure you are not using a language feature that has not been added yet. [See our docs on available language features](https://docs.chainsatlas.com/).
- Contact us at info@chainsatlas.com

## Contributing

We welcome contributions! If you have suggestions, bug reports, or feature requests, please open an issue on our GitHub repository.

---
